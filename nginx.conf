worker_processes 1;

events { worker_connections 1024; }

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Увеличен размер корзины для map (исправляет ошибку запуска)
    map_hash_bucket_size 128;

    client_max_body_size 20M;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    upstream auth_servers {
        server auth-service:8000;
    }

    upstream event_servers {
        server event-service:8001;
    }

    upstream attendance_servers {
        server attendance-service:8002;
    }

    upstream minio_console {
        server minio:9001;
    }

    upstream web_app {
        server web-app:5173;
    }

    map $http_accept $redirect_api_to_app {
        default 0;
        "~*text/html" 1;
    }

    map "$redirect_api_to_app$request_uri" $do_redirect {
        default 0;
        "1~*^/(auth|events|applications|volunteers|organizers)" 1;
    }

    server {
        listen 80;
        server_name localhost;

        # Глобальные заголовки CORS (наследуются везде)
        add_header 'Access-Control-Allow-Origin' $http_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin' always;
        add_header 'Access-Control-Max-Age' 1728000 always;

        # Обработка preflight-запросов
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Редирект API-запросов из браузера на фронт
        if ($do_redirect = 1) {
            return 302 /;
        }

        # --- БЛОКИРОВКА ДОКУМЕНТАЦИИ ---
        # Перенаправляем любые пути, заканчивающиеся на /docs или /redoc, на фронт
        location ~* ^/.*/(docs|redoc)$ {
            return 302 /;
        }

        # Если вдруг документация отдается просто от корня /docs
        location = /docs {
            return 302 /;
        }

        # Отдаем 404 Not Found при попытке скачать саму JSON-схему API
        location ~* ^/.*/openapi\.json$ {
            return 404;
        }
        # -------------------------------

        location /auth/ {
            proxy_pass http://auth_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /events {
            proxy_pass http://event_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /applications {
            proxy_pass http://event_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /volunteers {
            proxy_pass http://attendance_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /organizers {
            proxy_pass http://attendance_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /minio-admin/ {
            proxy_pass http://minio_console/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location / {
            proxy_pass http://web_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }
    }
}